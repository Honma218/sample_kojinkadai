# シーケンス図

## 1. ユーザー登録機能

```mermaid
sequenceDiagram
    participant Browser as ブラウザ
    participant UC as UserController
    participant UU as UserAuthUsecase
    participant UAR as UserAuthRepository
    participant UR as UserRepository
    participant DB as データベース

    Browser->>UC: POST /user/signup (UserForm)
    UC->>UC: バリデーション
    UC->>UU: userCreate(userForm, request)
    UU->>UU: パスワード一致チェック
    UU->>UR: findByUsername(username)
    UR->>DB: SELECT by username
    DB-->>UR: 検索結果
    UR-->>UU: Optional<User>
    UU->>UU: 重複チェック
    UU->>UAR: createUser(username, password)
    UAR->>DB: Spring Security用ユーザー作成
    UU->>UR: save(user)
    UR->>DB: INSERT user
    UU->>Browser: 自動ログイン
    UU-->>UC: 処理完了
    UC-->>Browser: redirect:/board
```

## 2. 投稿表示機能（タイムライン）

```mermaid
sequenceDiagram
    participant Browser as ブラウザ
    participant BC as BoardController
    participant PU as PostUseCase
    participant UCU as UserCommentUseCase
    participant UPU as UserProfileUseCase
    participant FR as FollowRepository
    participant PR as PostRepository
    participant UR as UserRepository
    participant DB as データベース

    Browser->>BC: GET /board
    BC->>UPU: getUserProfileByUsername(username)
    UPU->>UR: findByUsername(username)
    UR->>DB: SELECT by username
    DB-->>UR: User
    UR-->>UPU: User
    UPU-->>BC: User
    BC->>PU: getTimeline(userId)
    PU->>FR: findFollowingIdsByFollowerId(userId)
    FR->>DB: SELECT following_ids
    DB-->>FR: List<String>
    FR-->>PU: List<String>
    PU->>PR: findTimelineByUserIds(userIds)
    PR->>DB: SELECT posts by user_ids
    DB-->>PR: List<Post>
    PR-->>PU: List<Post>
    PU->>UR: findById(userId) (各投稿のユーザー情報)
    UR->>DB: SELECT by user_id
    DB-->>UR: User
    UR-->>PU: User
    PU-->>BC: List<PostWithUserDto>
    BC->>UCU: read() (後方互換)
    UCU-->>BC: UserComments
    BC-->>Browser: ModelAndView (board.html)
```

## 3. 投稿作成機能

```mermaid
sequenceDiagram
    participant Browser as ブラウザ
    participant BC as BoardController
    participant PU as PostUseCase
    participant UPU as UserProfileUseCase
    participant PR as PostRepository
    participant UR as UserRepository
    participant DB as データベース

    Browser->>BC: POST /board (CommentForm)
    BC->>BC: バリデーション
    BC->>UPU: getUserProfileByUsername(username)
    UPU->>UR: findByUsername(username)
    UR->>DB: SELECT by username
    DB-->>UR: User
    UR-->>UPU: User
    UPU-->>BC: User
    BC->>PU: createPost(userId, content)
    PU->>PU: Post.create(userId, content)
    PU->>PR: save(post)
    PR->>DB: INSERT post
    DB-->>PR: Post
    PR-->>PU: Post
    PU-->>BC: Post
    BC-->>Browser: redirect:/board
```

## 4. フォロー機能

```mermaid
sequenceDiagram
    participant Browser as ブラウザ
    participant FC as FollowController
    participant FU as FollowUseCase
    participant UPU as UserProfileUseCase
    participant FR as FollowRepository
    participant UR as UserRepository
    participant DB as データベース

    Browser->>FC: POST /follow/{userId}
    FC->>UPU: getUserProfileByUsername(username)
    UPU->>UR: findByUsername(username)
    UR->>DB: SELECT by username
    DB-->>UR: User
    UR-->>UPU: User
    UPU-->>FC: User
    FC->>FU: follow(followerId, followingId)
    FU->>FU: 自己フォローチェック
    FU->>FR: existsByFollowerIdAndFollowingId(followerId, followingId)
    FR->>DB: SELECT follow
    DB-->>FR: boolean
    FR-->>FU: boolean
    FU->>FU: 重複チェック
    FU->>FU: Follow.create(followerId, followingId)
    FU->>FR: save(follow)
    FR->>DB: INSERT follow
    DB-->>FR: Follow
    FR-->>FU: Follow
    FU-->>FC: 処理完了
    FC-->>Browser: ResponseEntity<String>
```

## 5. プロフィール表示機能

```mermaid
sequenceDiagram
    participant Browser as ブラウザ
    participant PC as ProfileController
    participant UPU as UserProfileUseCase
    participant UR as UserRepository
    participant PR as PostRepository
    participant FR as FollowRepository
    participant DB as データベース

    Browser->>PC: GET /profile/{userId}
    PC->>UPU: getUserProfileByUsername(username)
    UPU->>UR: findByUsername(username)
    UR->>DB: SELECT by username (現在のユーザー)
    DB-->>UR: User
    UR-->>UPU: User
    UPU-->>PC: User (currentUser)
    PC->>UPU: getUserProfile(userId)
    UPU->>UR: findById(userId)
    UR->>DB: SELECT by id (プロフィールユーザー)
    DB-->>UR: User
    UR-->>UPU: User
    UPU-->>PC: User (profileUser)
    PC->>PC: createProfileView(profileUser, isOwnProfile)
    PC->>UPU: getUserPosts(userId)
    UPU->>PR: findByUserId(userId)
    PR->>DB: SELECT posts by user_id
    DB-->>PR: List<Post>
    PR-->>UPU: List<Post>
    UPU-->>PC: List<Post>
    PC->>UPU: getFollowingCount(userId)
    UPU->>FR: countByFollowerId(userId)
    FR->>DB: COUNT following
    DB-->>FR: int
    FR-->>UPU: int
    UPU-->>PC: int
    PC->>UPU: getFollowerCount(userId)
    UPU->>FR: countByFollowingId(userId)
    FR->>DB: COUNT followers
    DB-->>FR: int
    FR-->>UPU: int
    UPU-->>PC: int
    PC-->>Browser: ModelAndView (profile/view.html)
```

## 6. ユーザー検索機能

```mermaid
sequenceDiagram
    participant Browser as ブラウザ
    participant SC as SearchController
    participant UPU as UserProfileUseCase
    participant FU as FollowUseCase
    participant UR as UserRepository
    participant DB as データベース

    Browser->>SC: GET /search?keyword={keyword}
    SC->>UPU: getUserProfileByUsername(username)
    UPU->>UR: findByUsername(username)
    UR->>DB: SELECT by username
    DB-->>UR: User
    UR-->>UPU: User
    UPU-->>SC: User (currentUser)
    
    alt キーワードあり
        SC->>UR: searchByDisplayName(keyword)
        UR->>DB: SELECT by display_name LIKE %keyword%
        DB-->>UR: List<User>
        UR-->>SC: List<User>
    else キーワードなし
        SC->>UR: findAll()
        UR->>DB: SELECT all users
        DB-->>UR: List<User>
        UR-->>SC: List<User>
    end
    
    SC->>SC: 自分を除外
    SC-->>Browser: ModelAndView (search/index.html)
```

## 7. 投稿編集・削除機能

```mermaid
sequenceDiagram
    participant Browser as ブラウザ
    participant BC as BoardController
    participant PU as PostUseCase
    participant UPU as UserProfileUseCase
    participant PR as PostRepository
    participant UR as UserRepository
    participant DB as データベース

    Browser->>BC: GET /board/edit/{id}
    BC->>UPU: getUserProfileByUsername(username)
    UPU->>UR: findByUsername(username)
    UR->>DB: SELECT by username
    DB-->>UR: User
    UR-->>UPU: User
    UPU-->>BC: User (currentUser)
    BC->>PU: getPost(id)
    PU->>PR: findById(id)
    PR->>DB: SELECT by id
    DB-->>PR: Optional<Post>
    PR-->>PU: Optional<Post>
    PU-->>BC: Post
    BC->>BC: 投稿者権限チェック
    BC-->>Browser: ModelAndView (board/edit.html)

    Browser->>BC: POST /board/edit/{id} (CommentForm)
    BC->>BC: バリデーション
    BC->>UPU: getUserProfileByUsername(username)
    UPU-->>BC: User (currentUser)
    BC->>PU: updatePost(id, content, userId)
    PU->>PR: findById(id)
    PR->>DB: SELECT by id
    DB-->>PR: Optional<Post>
    PR-->>PU: Optional<Post>
    PU->>PU: 投稿者権限チェック
    PU->>PU: post.update(content)
    PU->>PR: save(updatedPost)
    PR->>DB: UPDATE post
    DB-->>PR: Post
    PR-->>PU: Post
    PU-->>BC: Post
    BC-->>Browser: redirect:/board
```

## アーキテクチャ概要

このアプリケーションは以下の3層アーキテクチャを採用しています：

1. **プレゼンテーション層 (Controller)**
   - ユーザーからのリクエストを受け取り、レスポンスを返す
   - バリデーション、セッション管理、認証チェックを担当

2. **ビジネスロジック層 (UseCase)**
   - アプリケーションの核となるビジネスルールを実装
   - トランザクション管理、ドメインオブジェクトの操作を担当

3. **データアクセス層 (Repository)**
   - データベースとの通信を抽象化
   - CRUD操作とクエリの実装を担当

各層が疎結合になっており、依存関係は上位層から下位層への一方向となっています。